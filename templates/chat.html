<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chat Interface</title>
    <link rel="stylesheet" href="/static/css/chatStyle.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="container">
      <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle">
      <label for="sidebar-toggle" class="sidebar-toggle-label">
        <span class="toggle-icon">â˜°</span>
      </label>

      <aside class="sidebar">
        <button class="new-chat-btn" onclick="newChat()">+ New Chat</button>
        <div class="chat-history">
          <div class="history-item">Previous Chat 1</div>
          <div class="history-item">Previous Chat 2</div>
          <div class="history-item">Previous Chat 3</div>
        </div>
        
        <div class="profile-section">
          <div class="profile-btn" onclick="goToProfile()">
            <span class="profile-name">My Profile</span>
            <img src="https://cdnb.artstation.com/p/assets/images/images/084/124/297/large/matthew-blank-profile-photo-2.jpg?1737590042" 
                 alt="Profile" class="profile-img">
          </div>
        </div>

      </aside>

     <main class="main-content">
        <div class="chat-area">
          <!-- Messages will appear here -->
        </div>

        <form id="messageForm" method="post" action="/prompt" enctype="multipart/form-data">

          <div class="input-container">
            <div class="input-area">
              <!-- for selected file -->
              <div id="fileInfo" class="file-info"></div> 
              
              <textarea name="message" placeholder="Write your message here..." required></textarea>
              <div class="bottom-controls">
                <div class="left-controls">

                  <label for="fileUpload" class="upload-btn" title="Upload file">+</label>
                  <input type="file" id="fileUpload" name="file" class="upload-btn" style="display: none;">

                  <select name="model" class="model-dropdown" required>
                    <option value="">Search Model</option>
                    <option value="Deepseek R1">Deepseek R1</option>
                    <option value="ChatGPT">ChatGPT</option>
                    <option value="Grok">Grok</option>
                    <option value="Google">Google</option>
                  </select>
                  
                  <select name="search" class="search-dropdown" required>
                    <option value="">Search Type</option>
                    <option value="Web Search">Web Search</option>
                    <option value="Pro Search">Pro Search</option>
                    <option value="Deep Research">Deep Research</option>
                    <option value="Pdf/links Talks">Pdf/links Talks</option>
                  </select>
                  
                  <button type="submit" class="send-btn">Send</button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </main>
    </div> 
    <script>
      function goToProfile() {
              window.location.href = `/user/{{ user_id }}/profile`;
          }
      function newChat(){
        document.querySelector(".chat-area").innerHTML=""
      }

      function displayFileInfo() {
        const fileInput = document.getElementById("fileUpload");
        const fileInfo = document.getElementById("fileInfo");
    
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          fileInfo.innerHTML = `ðŸ“„ ${file.name} (${(file.size / 1024).toFixed(2)} KB)<br><br>`;
          fileInfo.style.display = "block";
        } else {
          fileInfo.innerHTML = "";
          fileInfo.style.display = "none";
        }
      }
      document.getElementById("fileUpload").addEventListener("change", displayFileInfo);

      document.getElementById("messageForm").addEventListener("submit", async function(event) {
        event.preventDefault(); 

        let modelDropdown = document.querySelector("select[name='model']");
        let searchDropdown = document.querySelector("select[name='search']");

        let chatArea = document.querySelector(".chat-area");
        let messageInput = document.querySelector("textarea[name='message']");
        let userMessageText = messageInput.value.trim();
        
        if (!modelDropdown.value || !searchDropdown.value) {
        alert("Please select both a model and a search type.");
        return; 
        }

        if (!userMessageText) return; 

        //user message
        let userMessage = document.createElement("div");
        userMessage.classList.add("chat-message", "user-message");
        userMessage.textContent = userMessageText;
        chatArea.appendChild(userMessage);
        chatArea.scrollTop = chatArea.scrollHeight;

        // before ai message
        let aiMessage = document.createElement("div");
        aiMessage.classList.add("chat-message", "ai-message");
        aiMessage.innerHTML = `
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        `;
        
        chatArea.appendChild(aiMessage);
        chatArea.scrollTop = chatArea.scrollHeight;

        // send request
        let formData = new FormData(this);

        document.querySelector("textarea[name='message']").value = "";
        document.getElementById("fileInfo").innerHTML = "";

        let response = await fetch("/prompt", {
            method: "POST",
            body: formData
        });

        // ai response
        if (response.ok) {
            let result = await response.json();
            // let formattedAIResponse = result.ai_response
            //   .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>") // Bold (**text**)
            //   .replace(/(?<!\w)_(.*?)_(?!\w)/g, "<i>$1</i>") // Italic (_text_)
            //   .replace(/~(.*?)~/g, "<u>$1</u>") // Underline (~text~)
            //   .replace(/~~(.*?)~~/g, "<s>$1</s>") // Strikethrough (~~text~~)
            //   .replace(/`(.*?)`/g, "<code>$1</code>") // Inline code (`code`)
            //   .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="$1">$2</code></pre>') // Code block (```code```)
            //   .replace(/###### (.*?)(\n|$)/g, "<h6>$1</h6>") // Headings
            //   .replace(/##### (.*?)(\n|$)/g, "<h5>$1</h5>")
            //   .replace(/#### (.*?)(\n|$)/g, "<h4>$1</h4>")
            //   .replace(/### (.*?)(\n|$)/g, "<h3>$1</h3>")
            //   .replace(/## (.*?)(\n|$)/g, "<h2>$1</h2>")
            //   .replace(/# (.*?)(\n|$)/g, "<h1>$1</h1>")
            //   .replace(/^> (.*?)(\n|$)/gm, "<blockquote>$1</blockquote>") // Blockquotes
            //   .replace(/(?:^|\n)[*-] (.*?)(\n|$)/g, "<ul><li>$1</li></ul>") // Unordered list
            //   .replace(/(?:^|\n)(\d+\.) (.*?)(\n|$)/g, "<ol><li>$2</li></ol>") // Ordered list
            //   .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank">$1</a>') // Links
            //   .replace(/!\[([^\]]*)\]\((https?:\/\/[^\s)]+)\)/g, '<img src="$2" alt="$1">') // Images
            //   .replace(/^---$/gm, "<hr>"); // Horizontal line

              let formattedAIResponse = marked.parse(result.ai_response);
              aiMessage.innerHTML = formattedAIResponse; 
              // aiMessage.innerHTML = result.ai_response; 

        } else {
            console.error("Failed to send data.");
        }
    });

    document.querySelector("textarea[name='message']").addEventListener("keydown", function(event) {
        if (event.key === "Enter" && !event.shiftKey) { 
            event.preventDefault(); 
            document.getElementById("messageForm").dispatchEvent(new Event("submit", { cancelable: true })); 
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const textarea = document.querySelector("textarea");
        textarea.addEventListener("input", function () {
            this.style.height = "auto"; // Reset height to auto
            this.style.height = this.scrollHeight + "px"; // Adjust height to content
        });
    });
    </script>
  </body>
</html>